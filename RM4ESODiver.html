<!DOCTYPE html>
<html lang="es">
<head>
	<link rel="manifest" href="./manifest.json" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon añadido -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>Plan de Razonamiento Matemático - 4º ESO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .week-card {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            transform: scale(1);
        }
        .week-card.filtered-out {
            opacity: 0.15;
            transform: scale(0.98);
        }
        .session-card.highlight {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px #4F46E5;
        }
        .hidden-week {
            display: none !important;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">

        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Plan de Razonamiento Matemático (4º de ESO)</h1>
            <p class="mt-2 text-lg text-gray-600">Cronograma interactivo para 4º de ESO - Itinerario de Diversificación Curricular (<span id="total-weeks-display">36 semanas</span>)</p>
        </header>

        <main>
            <section id="controls" class="mb-12 p-6 bg-white rounded-2xl shadow-sm">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Filtrar por Asignatura</h3>
                    <div id="subject-filters" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Filtrar por Ámbito</h3>
                    <div id="ambito-filters" class="flex flex-wrap gap-2"></div>
                </div>
                 <div class="mt-6 text-center">
                    <button id="reset-filters" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition">Mostrar Todo</button>
                </div>
            </section>
            
            <section id="summary" class="mb-12">
                 <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-xl font-bold text-gray-800 text-center mb-4">Distribución Proporcional de Sesiones</h2>
                    <p class="text-center text-gray-600 mb-6 max-w-2xl mx-auto">
                        Este gráfico ilustra la distribución de las sesiones adicionales a lo largo del ciclo completo de 36 semanas. La asignación es directamente proporcional a la carga horaria semanal de cada materia, garantizando un reparto equitativo del trabajo interdisciplinar de razonamiento matemático.
                    </p>
                    <div class="chart-container relative w-full max-w-lg mx-auto h-80 md:h-96">
                        <canvas id="proportionalityChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="schedule">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">Cronograma del Curso Escolar Completo</h2>
                <div id="evaluations-container" class="space-y-6">
                    <!-- Primera Evaluación: del 15 de septiembre de 2025 al 12 de diciembre (14 semanas) -->
                    <div class="evaluation-section bg-white rounded-2xl shadow-sm overflow-hidden">
                        <button class="w-full text-left p-6 flex justify-between items-center cursor-pointer focus:outline-none" onclick="toggleEvaluation(1)">
                            <h3 class="text-xl font-bold text-gray-800">Primera Evaluación (Semanas 1-14)</h3>
                            <span id="toggle-icon-1" class="text-2xl font-bold transform transition-transform duration-300">+</span>
                        </button>
                        <div id="evaluation-content-1" class="p-5 border-t border-gray-200 space-y-6 hidden">
                            <!-- Las semanas se renderizarán aquí -->
                        </div>
                    </div>
                    <!-- Segunda Evaluación: del 12 de enero de 2026 al 28 de marzo (11 semanas) -->
                    <div class="evaluation-section bg-white rounded-2xl shadow-sm overflow-hidden">
                        <button class="w-full text-left p-6 flex justify-between items-center cursor-pointer focus:outline-none" onclick="toggleEvaluation(2)">
                            <h3 class="text-xl font-bold text-gray-800">Segunda Evaluación (Semanas 15-25)</h3>
                            <span id="toggle-icon-2" class="text-2xl font-bold transform transition-transform duration-300">+</span>
                        </button>
                        <div id="evaluation-content-2" class="p-5 border-t border-gray-200 space-y-6 hidden">
                            <!-- Las semanas se renderizarán aquí -->
                        </div>
                    </div>
                    <!-- Tercera Evaluación: del 6 de abril al 19 de junio (11 semanas) -->
                    <div class="evaluation-section bg-white rounded-2xl shadow-sm overflow-hidden">
                        <button class="w-full text-left p-6 flex justify-between items-center cursor-pointer focus:outline-none" onclick="toggleEvaluation(3)">
                            <h3 class="text-xl font-bold text-gray-800">Tercera Evaluación (Semanas 26-36)</h3>
                            <span id="toggle-icon-3" class="text-2xl font-bold transform transition-transform duration-300">+</span>
                        </button>
                        <div id="evaluation-content-3" class="p-5 border-t border-gray-200 space-y-6 hidden">
                            <!-- Las semanas se renderizarán aquí -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Configuraciones ajustadas a 36 semanas ---
        const TOTAL_WEEKS = 36;
        const EVALUATION_WEEKS = {
            1: { start: 1, end: 14 }, // 14 semanas: 15/sep al 12/dic
            2: { start: 15, end: 25 }, // 11 semanas: 12/ene al 28/mar
            3: { start: 26, end: TOTAL_WEEKS } // 11 semanas: 6/abr al 19/jun
        };

        // Datos del CSV con enlaces de evidencia (CORREGIDO EL TYPO 'httpss' en Semana 16)
        const csvData = `,Sesión 1,Sesión 2,Sesión 3
Semana 1,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B5,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E5,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H5
Semana 2,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B10,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E10,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H10
Semana 3,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B17,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E17,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H17
Semana 4,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B22,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E22,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H22
Semana 5,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B27,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E27,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H27
Semana 6,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B32,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E32,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H32
Semana 7,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B37,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E37,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H37
Semana 8,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B44,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E44,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H44
Semana 9,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B49,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E49,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H49
Semana 10,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B54,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E54,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H54
Semana 11,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B59,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E59,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H59
Semana 12,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B66,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E66,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H66
Semana 13,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B71,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E71,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H71
Semana 14,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B76,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E76,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H76
Semana 15,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B83,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E83,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H83
Semana 16,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B88,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E88,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H88
Semana 17,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B93,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E93,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H93
Semana 18,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B100,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E100,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H100
Semana 19,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B105,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E105,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H105
Semana 20,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B110,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E110,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H110
Semana 21,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B115,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E115,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H115
Semana 22,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B122,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E122,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H122
Semana 23,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B127,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E127,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H127
Semana 24,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B132,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E132,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H132
Semana 25,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B137,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E137,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H137
Semana 26,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B144,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E144,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H144
Semana 27,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B149,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E149,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H149
Semana 28,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B154,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E154,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H154
Semana 29,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B159,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E159,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H159
Semana 30,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B166,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E166,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H166
Semana 31,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B171,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E171,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H171
Semana 32,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B176,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E176,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H176
Semana 33,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B181,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E181,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H181
Semana 34,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B188,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E188,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H188
Semana 35,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B193,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E193,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H193
Semana 36,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B198,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E198,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H198`;

        // Parsear el CSV para crear un objeto con los enlaces por semana y sesión
        const evidenceLinks = {};
        const csvLines = csvData.split('\n');
        
        // Ignorar la primera línea (cabecera)
        for (let i = 1; i < csvLines.length; i++) {
            const line = csvLines[i].trim();
            if (!line) continue;
            
            const parts = line.split(',');
            if (parts.length >= 4) {
                const weekNumber = parseInt(parts[0].replace('Semana ', ''));
                evidenceLinks[weekNumber] = {
                    session1: parts[1],
                    session2: parts[2],
                    session3: parts[3]
                };
            }
        }

        // Distribución de horas semanales para el cálculo proporcional (no cambia)
        const horasSemanales = {
            'Ámbito Socio-Lingüístico': 9,
            'Religión': 1,
            'Ámbito Científico-Tecnológico': 8,
            'Cultura Científica': 2,
            'Expresión Artística': 3,
            'Música': 3,
            'Educación Física': 2,
            'Dibujo Técnico': 2
        };

        // Asignación de asignaturas a los ámbitos - CORREGIDO
        const ambitoMaterias = {
            'Ámbito Socio-Lingüístico': 'SL',
            'Religión': 'SL',
            'Ámbito Científico-Tecnológico': 'CT',
            'Cultura Científica': 'CT',
            'Expresión Artística': 'AR',
            'Música': 'AR',
            'Educación Física': 'AR',
            'Dibujo Técnico': 'AR'
        };

        // Criterios de Evaluación Reales del Anexo IV (Segundo Curso - 4º ESO)
        const criteriosCT = [
            { id: "CT.1.1", text: "Reconocer situaciones susceptibles de ser formuladas y resueltas mediante herramientas y estrategias matemáticas, planteando variantes, modificando alguno de sus datos o alguna condición del problema y proporcionando una representación matemática adecuada." },
            { id: "CT.1.2", text: "Comprobar la validez de las soluciones a un problema desde un punto de vista lógico-matemático, verbalizando de forma clara y concisa el procedimiento seguido, y elaborar las respuestas evaluando su alcance, repercusión y coherencia en su contexto." },
            { id: "CT.2.1", text: "Reconocer y usar las relaciones entre los conocimientos y experiencias matemáticas formando un todo coherente, reconociendo y utilizando las conexiones entre ideas matemáticas en la resolución de problemas." },
            { id: "CT.3.1", text: "Establecer conexiones entre el mundo real y las matemáticas usando los procesos inherentes a la investigación científica y matemática: inferir, medir, comunicar, clasificar y predecir, aplicando distintos procedimientos en la resolución de problemas en situaciones diversas." },
            { id: "CT.3.2", text: "Analizar conexiones coherentes en el entorno próximo, entre las necesidades tecnológicas, ambientales, económicas y sociales más importantes que demanda la sociedad para reconocer la capacidad de la ciencia para darle solución a situaciones de la vida cotidiana." },
            { id: "CT.4.1", text: "Gestionar las emociones propias y desarrollar el autoconcepto matemático como herramienta, generando expectativas positivas ante nuevos retos, pensando de forma crítica y creativa, adaptándose ante la incertidumbre y reconociendo fuentes de estrés." },
            { id: "CT.5.1", text: "Interpretar el paisaje analizando el origen, relación y evolución integrada de sus elementos, entendiendo los procesos geológicos que lo han formado y los fundamentos que determinan su dinámica." },
            { id: "CT.6.1", text: "Interpretar y comprender problemas matemáticos complejos de la vida cotidiana y fenómenos fisicoquímicos, organizando y analizando los datos dados, estableciendo relaciones entre ellos, comprendiendo las preguntas formuladas y explicarlos en términos básicos de los principios, teorías y leyes científicas." },
            { id: "CT.7.1", text: "Analizar preguntas e hipótesis que puedan ser respondidas o contrastadas, a través de la indagación, la deducción, el trabajo experimental y el razonamiento lógico-matemático, utilizando métodos científicos." },
            { id: "CT.8.1", text: "Resolver problemas cotidianos complejos o dar explicación a procesos naturales, trabajando la abstracción para determinar los aspectos más relevantes, utilizando conocimientos, organizando datos e información aportados a través del razonamiento lógico, el pensamiento computacional o recursos digitales." },
            { id: "CT.9.1", text: "Analizar conceptos y procesos relacionados con los saberes de Biología y Geología, Física y Química y Matemáticas interpretando información en diferentes formatos (modelos, gráficos, tablas, diagramas, fórmulas, etc.), manteniendo una actitud crítica." },
            { id: "CT.10.1", text: "Utilizar recursos variados, tradicionales y digitales, para el correcto trabajo autónomo y cooperativo de saberes científicos, seleccionando, analizando críticamente y representando información, mediante el uso distintas fuentes." },
            { id: "CT.11.1", text: "Relacionar con fundamentos científicos la preservación de la biodiversidad, la conservación del medio ambiente, la protección de los seres vivos del entorno, el desarrollo sostenible y la calidad de vida, comprendiendo la repercusión global de actuaciones locales." }
        ];

        const criteriosSL = [
            { id: "SL.1.1", text: "Reconocer y valorar las lenguas de España y alguna de las variedades dialectales, especialmente la modalidad lingüística andaluza a partir de su estudio histórico, contrastando sus diferencias y actuando de forma empática y respetuosa." },
            { id: "SL.2.1", text: "Comprender e interpretar el sentido global, estructura e información más relevante en función de las necesidades comunicativas y la intención del emisor en textos orales, escritos y multimodales sobre temas frecuentes y de la vida cotidiana." },
            { id: "SL.3.1", text: "Realizar narraciones y exposiciones sencillas en lengua castellana, así como textos orales, escritos y multimodales en lengua extranjera, atendiendo a los diversos géneros discursivos en ambas lenguas, con coherencia y corrección." },
            { id: "SL.4.1", text: "Comprender e interpretar el sentido global, la estructura, la información más relevante y la intención del emisor de textos escritos y multimodales sencillos de diferentes ámbitos en lengua castellana y en lengua extranjera." },
            { id: "SL.5.1", text: "Planificar la redacción de textos escritos y multimodales sencillos en lengua castellana, atendiendo a la situación comunicativa, destinatario, propósito y canal; redactar borradores y revisarlos... y presentar un texto final coherente." },
            { id: "SL.6.1", text: "Buscar, seleccionar y contrastar información mediante la consulta de diferentes fuentes, desarrollando estrategias de búsqueda, selección y tratamiento de información relativas a procesos y acontecimientos relevantes del presente y del pasado." },
            { id: "SL.7.3", text: "Identificar e interpretar la conexión de España y Andalucía con los grandes procesos históricos, valorando su evolución y vinculándola con los desafíos del mundo actual." },
            { id: "SL.8.2", text: "Utilizar un metalenguaje específico, en lengua castellana y en lengua extranjera, para explicar y argumentar la interrelación entre el propósito comunicativo y las elecciones lingüísticas en situaciones comunicativas cotidianas." },
            { id: "SL.9.1", text: "Identificar, interpretar y analizar los mecanismos que han regulado la convivencia y la vida en común a lo largo de la historia, destacando las actitudes pacíficas y tolerantes que favorecen la convivencia democrática." },
            { id: "SL.10.1", text: "Identificar y analizar de forma crítica el entorno desde una perspectiva sistémica e integradora, a través del concepto de paisaje y sus elementos, reflexionando sobre la evolución de los ciclos demográficos." }
        ];

        // --- ACTIVIDADES ESPECÍFICAS PARA MATERIAS NO-ÁMBITO (ACTUALIZADAS CON RAZONAMIENTO MATEMÁTICO) ---
        const actividadesPorMateria = {
            'Religión': [
                "Análisis estadístico de datos demográficos sobre prácticas religiosas: calcular porcentajes, medias y elaborar gráficos comparativos entre diferentes confesiones.",
                "Cálculo de proporciones en arquitectura religiosa histórica: aplicar razones, escalas y geometría para analizar catedrales y mezquitas.",
                "Resolución de problemas sobre distribución equitativa de recursos en comunidades basada en principios éticos y cálculos matemáticos.",
                "Análisis temporal de eventos religiosos históricos: calcular intervalos entre fechas significativas y crear líneas de tiempo cuantitativas.",
                "Interpretación de patrones geométricos en arte sacro: cálculo de simetrías, proporciones áureas y transformaciones geométricas."
            ],
            
            'Cultura Científica': [
                "Análisis de datos epidemiológicos: cálculo de tasas de incidencia, prevalencia e interpretación de gráficos de evolución con proyecciones matemáticas.",
                "Resolución de problemas sobre sostenibilidad: cálculo de huella ecológica, análisis de datos de consumo energético y modelización matemática de impactos ambientales.",
                "Interpretación de estudios científicos: análisis estadístico de resultados, cálculo de promedios, desviaciones estándar y significancia estadística.",
                "Cálculo de magnitudes en experimentos: conversión de unidades, análisis dimensional y aplicación de fórmulas científicas con variables cuantitativas.",
                "Análisis de datos climáticos: interpretación de series temporales, cálculo de tendencias mediante regresión lineal y predicciones basadas en modelos matemáticos."
            ],
            
            'Expresión Artística': [
                "Cálculo matemático de proporciones áureas en composiciones artísticas: aplicación de razones y medidas para análisis estético cuantitativo.",
                "Análisis geométrico de perspectivas en dibujo: cálculo de puntos de fuga, relaciones espaciales y aplicación de sistemas de coordenadas.",
                "Cálculo matemático de mezclas de colores: proporciones porcentuales, relaciones RGB y modelización matemática de teoría del color.",
                "Análisis de ritmos y patrones en diseño: identificación de secuencias matemáticas, progresiones y aplicaciones de simetría.",
                "Cálculo de escalas y dimensiones en maquetas: aplicación de factores de escala, proporciones y geometría espacial en proyectos tridimensionales."
            ],
            
            'Música': [
                "Cálculo matemático de proporciones en intervalos musicales: análisis de relaciones numéricas en escalas y aplicación de razones armónicas.",
                "Análisis matemático de compases y ritmos: identificación de patrones fraccionarios, cálculo de duraciones y aplicación de operaciones con fracciones.",
                "Cálculo de frecuencias y relaciones armónicas: aplicación de progresiones geométricas, logaritmos y funciones exponenciales en acústica musical.",
                "Análisis estadístico de preferencias musicales: interpretación de encuestas, cálculo de modas, medianas y elaboración de gráficos de distribución.",
                "Resolución de problemas sobre tempo y duraciones: cálculo de proporciones en cambios de velocidad, compases compuestos y transformaciones rítmicas."
            ],
            
            'Educación Física': [
                "Cálculo de estadísticas deportivas: promedios, porcentajes de efectividad, análisis de rendimiento mediante medidas de tendencia central.",
                "Análisis geométrico de trayectorias en deportes: cálculo de ángulos, distancias, parábolas y aplicación de funciones cuadráticas.",
                "Resolución de problemas sobre dosificación de entrenamiento: proporciones, progresiones aritméticas y cálculos de intensidad mediante fórmulas.",
                "Cálculo de índices corporales: IMC, porcentaje de grasa, análisis de datos antropométricos y elaboración de gráficos de seguimiento.",
                "Análisis de estrategias deportivas mediante teoría de juegos: cálculo de probabilidades, matrices de decisión y optimización de resultados."
            ],
            
            'Dibujo Técnico': [
                "Resolución de problemas de geometría descriptiva: cálculo de verdaderas magnitudes, relaciones espaciales y aplicación de trigonometría.",
                "Aplicación matemática de proporciones áureas en diseño: cálculo de relaciones matemáticas, sucesiones y aplicación de números irracionales.",
                "Cálculo de escalas y acotaciones: conversión entre medidas reales y representaciones, aplicación de factores de escala y proporcionalidad.",
                "Análisis matemático de simetrías y transformaciones: identificación de patrones, aplicación de matrices de transformación y geometría analítica.",
                "Resolución de problemas de tangencias y enlaces: aplicación de propiedades geométricas, teoremas y resolución de sistemas de ecuaciones."
            ]
        };

        // Funciones de utilidad
        function getRandomElement(arr) {
            if (!arr || arr.length === 0) return { id: "error", text: "Array de criterios vacío" };
            return arr[Math.floor(Math.random() * arr.length)];
        }

        // Función para obtener actividad específica según materia
        function obtenerActividadEspecifica(materia) {
            const actividades = actividadesPorMateria[materia];
            if (actividades && actividades.length > 0) {
                return actividades[Math.floor(Math.random() * actividades.length)];
            }
            return `Actividad de razonamiento matemático en el contexto de ${materia}.`;
        }

        function generateCTActivity(criterio) {
            if (!criterio) return "Actividad de CT no definida.";
            switch (criterio.id) {
                case "CT.1.1": return "Planteamiento de un problema (ej. factura de luz) y búsqueda de 3 formas distintas de representarlo matemáticamente (ecuación, tabla, gráfico).";
                case "CT.1.2": return "Ejercicio de 'Comprobación de Errores': Analizar un problema resuelto (con fallos) y verbalizar dónde está el error lógico y cuál sería la solución coherente.";
                case "CT.2.1": return "Mapa conceptual conectando conceptos: ¿Cómo se relaciona la 'función lineal' con el 'porcentaje' y con el cálculo de 'velocidad media'?";
                case "CT.3.1": return "Taller de 'Mates en la Cocina': Inferir, medir y predecir cantidades para una receta, aplicando proporcionalidad y conversión de unidades (ml a L, g a kg).";
                case "CT.3.2": return "Debate: ¿Qué modelo matemático (crecimiento lineal, exponencial) explica mejor el consumo de recursos en nuestra ciudad? Analizar datos reales.";
                case "CT.4.1": return "Resolución de un 'problema imposible' (sin solución aparente) para gestionar la frustración y desarrollar estrategias creativas de aproximación.";
                case "CT.5.1": return "Análisis de una foto de un paisaje local (ej. una rambla): Identificar procesos geológicos (erosión, sedimentación) y razonar su evolución futura.";
                case "CT.6.1": return "Interpretación de un fenómeno fisicoquímico (ej. dilución): Organizar datos, establecer la relación (proporcionalidad) y formular la ley científica.";
                case "CT.7.1": return "Proyecto de indagación: Formular una hipótesis (ej. 'El ángulo de un panel solar afecta a la energía recogida') y diseñar un experimento simple para contrastarla.";
                case "CT.8.1": return "Uso de pensamiento computacional: Crear un diagrama de flujo (algoritmo) para resolver un problema cotidiano (ej. 'Decidir la mejor ruta al instituto').";
                case "CT.9.1": return "Análisis de infografías científicas (ej. ciclo del agua, estructura del átomo): Interpretar los gráficos, tablas y diagramas para extraer conclusiones.";
                case "CT.10.1": return "Búsqueda y crítica de fuentes: Comparar dos noticias sobre un avance científico (una de un medio fiable, otra de un blog) y analizar críticamente la información.";
                case "CT.11.1": return "Cálculo de la huella hídrica o de carbono personal. Relacionar los resultados con el desarrollo sostenible y proponer acciones locales de mejora.";
                default: return "Resolver problemas matemáticos aplicados a un contexto científico, analizando la validez de las soluciones.";
            }
        }

        function generateSLActivity(criterio) {
            if (!criterio) return "Actividad de SL no definida.";
            switch (criterio.id) {
                case "SL.1.1":
                    return "Análisis estadístico de la distribución geográfica de hablantes de diferentes lenguas en España: calcular porcentajes, crear gráficos circulares y analizar datos demográficos sobre el uso del andaluz y otras variedades dialectales.";
                case "SL.2.1":
                    return "Interpretación de datos en textos multimodales: analizar infografías periodísticas con datos estadísticos sobre migraciones, calcular tasas de crecimiento y elaborar gráficos de evolución histórica de fenómenos sociales.";
                case "SL.3.1":
                    return "Exposición oral con soporte matemático: presentar datos demográficos de Andalucía usando porcentajes, proporciones y gráficos estadísticos, aplicando razonamiento lógico para explicar tendencias históricas.";
                case "SL.4.1":
                    return "Análisis cuantitativo de textos históricos: interpretar datos económicos en documentos del siglo XIX, calcular variaciones porcentuales de producción industrial y elaborar tablas comparativas de desarrollo económico.";
                case "SL.5.1":
                    return "Redacción de informe sobre desigualdades sociales: planificar y redactar un texto analizando datos estadísticos sobre distribución de la renta, calcular coeficientes de Gini e interpretar gráficos de desigualdad económica.";
                case "SL.6.1":
                    return "Investigación con tratamiento de datos: buscar y contrastar fuentes sobre evolución demográfica, calcular tasas de natalidad/mortalidad y elaborar pirámides de población para diferentes periodos históricos.";
                case "SL.7.3":
                    return "Análisis cuantitativo de procesos históricos: crear líneas de tiempo con datos demográficos y económicos, calcular crecimiento poblacional y analizar estadísticamente la conexión de España con procesos europeos.";
                case "SL.8.2":
                    return "Análisis lingüístico-matemático: examinar el uso de datos numéricos en discursos políticos, verificar la exactitud estadística y aplicar razonamiento lógico para evaluar la validez de argumentos cuantitativos.";
                case "SL.9.1":
                    return "Estudio estadístico de mecanismos de convivencia: analizar datos sobre resolución de conflictos, calcular frecuencias y porcentajes, y elaborar gráficos sobre la evolución de actitudes pacíficas en sociedades democráticas.";
                case "SL.10.1":
                    return "Análisis matemático del paisaje y demografía: interpretar datos de ciclos demográficos, calcular densidades de población, analizar estadísticas de éxodo rural y crear mapas temáticos con distribución espacial de datos.";
                default:
                    return "Análisis de textos sociales o históricos integrando interpretación de datos estadísticos, cálculo de porcentajes y elaboración de representaciones gráficas para apoyar el razonamiento lógico.";
            }
        }

        // Criterios de evaluación (ejemplos adaptados para 4º ESO Diversificación)
        const criteriosEvaluacion = {
            'Expresión Artística': [
                'AR.C.E.1.4. Analizar la proporción y la estructura geométrica en obras de arte, comprendiendo su impacto estético.',
                'AR.C.E.2.2. Desarrollar un proceso creativo, aplicando la lógica y la secuencia para la producción de obras artísticas.',
            ],
            'Música': [
                'AR.C.E.3.5. Interpretar patrones rítmicos y estructuras formales en obras musicales, relacionándolos con conceptos numéricos.',
            ],
            'Educación Física': [
                'EF.C.E.1.3. Analizar la estrategia de juego en deportes de equipo, comprendiendo la lógica táctica.',
                'EF.C.E.2.2. Diseñar un plan de entrenamiento, aplicando el razonamiento para optimizar el rendimiento y la seguridad.',
                'EF.C.E.3.1. Interpretar la cinemática de los movimientos corporales, utilizando conceptos de física y geometría.',
            ],
            'Dibujo Técnico': [
                'DT.C.E.1.1. Representar objetos en el plano, utilizando el razonamiento espacial y las normas de la representación gráfica.',
                'DT.C.E.2.3. Resolver problemas geométricos complejos, aplicando los principios de la geometría plana y del espacio.',
                'DT.C.E.3.4. Emplear el razonamiento lógico para la lectura e interpretación de planos y croquis.',
            ],
            'Cultura Científica': [
                'CC.C.E.1.2. Interpretar datos científicos presentados en gráficos y tablas, extrayendo conclusiones lógicas.',
                'CC.C.E.2.3. Analizar la argumentación en debates científicos, identificando la validez de las hipótesis y las pruebas.',
                'CC.C.E.3.1. Utilizar el pensamiento crítico para la evaluación de la información científica de diversas fuentes.'
            ],
            'Religión': [
                'RE.C.E.1.2. Analizar dilemas éticos y morales, aplicando un razonamiento coherente para la toma de decisiones.',
                'RE.C.E.2.1. Interpretar textos sagrados, identificando la estructura lógica y el mensaje principal.',
            ]
        };

        // Función original, ahora solo para materias no-Ámbito
        function seleccionarCriterio(materia) {
            const criterios = criteriosEvaluacion[materia];
            return criterios ? criterios[Math.floor(Math.random() * criterios.length)] : 'Criterio de evaluación no especificado';
        }
        
        const totalHoras = Object.values(horasSemanales).reduce((sum, h) => sum + h, 0);
        // Ajustado a 36 semanas * 2 sesiones/semana = 72 sesiones
        const totalSesionesAdicionales = TOTAL_WEEKS * 2; 
        
        const sesionesProporcionales = Object.keys(horasSemanales).reduce((acc, materia) => {
            // Utilizamos el total de sesiones adicionales
            acc[materia] = Math.round((horasSemanales[materia] / totalHoras) * totalSesionesAdicionales);
            return acc;
        }, {});
        
        // Ajuste fino para asegurar que la suma es exactamente totalSesionesAdicionales (72)
        const currentSum = Object.values(sesionesProporcionales).reduce((sum, n) => sum + n, 0);
        const diff = totalSesionesAdicionales - currentSum;
        if (diff !== 0) {
            // Añade/resta la diferencia a la materia con más peso para mantener la proporción
            const primarySubject = 'Ámbito Socio-Lingüístico'; // Mayor peso
            sesionesProporcionales[primarySubject] = (sesionesProporcionales[primarySubject] || 0) + diff;
        }

        // --- ALGORITMO MEJORADO: Distribución por semanas sin repetición y sin consecutivas ---
        function distribuirMateriasOptimizado() {
            // Calcular sesiones por evaluación
            const sesionesPorEvaluacion = {
                1: 14 * 2, // 28 sesiones
                2: 11 * 2, // 22 sesiones  
                3: 11 * 2  // 22 sesiones
            };
            
            // Crear arrays separados para cada evaluación
            const evaluaciones = {
                1: [],
                2: [], 
                3: []
            };
            
            // Para cada materia, distribuir sus sesiones entre las evaluaciones
            Object.keys(sesionesProporcionales).forEach(materia => {
                const totalSesionesMateria = sesionesProporcionales[materia];
                
                // Calcular distribución ideal entre evaluaciones
                const distribucionIdeal = {
                    1: Math.round(totalSesionesMateria * (sesionesPorEvaluacion[1] / totalSesionesAdicionales)),
                    2: Math.round(totalSesionesMateria * (sesionesPorEvaluacion[2] / totalSesionesAdicionales)),
                    3: totalSesionesMateria // Se ajustará después
                };
                
                // Ajustar para que sume el total
                distribucionIdeal[3] = totalSesionesMateria - distribucionIdeal[1] - distribucionIdeal[2];
                
                // Asegurar que no haya valores negativos
                if (distribucionIdeal[3] < 0) {
                    distribucionIdeal[3] = 0;
                    // Reajustar las otras dos
                    const sobrante = Math.abs(distribucionIdeal[3]);
                    if (distribucionIdeal[1] > sobrante) {
                        distribucionIdeal[1] -= sobrante;
                    } else if (distribucionIdeal[2] > sobrante) {
                        distribucionIdeal[2] -= sobrante;
                    }
                }
                
                // Añadir las sesiones a cada evaluación
                for (let i = 0; i < distribucionIdeal[1]; i++) evaluaciones[1].push(materia);
                for (let i = 0; i < distribucionIdeal[2]; i++) evaluaciones[2].push(materia);
                for (let i = 0; i < distribucionIdeal[3]; i++) evaluaciones[3].push(materia);
            });
            
            // Mezclar cada evaluación por separado (pero de forma determinista)
            const mezclarDeterminista = (array) => {
                const nuevoArray = [...array];
                for (let i = nuevoArray.length - 1; i > 0; i--) {
                    const j = Math.floor((i * 13 + 7) % (i + 1));
                    [nuevoArray[i], nuevoArray[j]] = [nuevoArray[j], nuevoArray[i]];
                }
                return nuevoArray;
            };
            
            // Mezclar cada evaluación
            evaluaciones[1] = mezclarDeterminista(evaluaciones[1]);
            evaluaciones[2] = mezclarDeterminista(evaluaciones[2]);
            evaluaciones[3] = mezclarDeterminista(evaluaciones[3]);
            
            // Combinar todas las evaluaciones en un solo pool
            let poolMaterias = [...evaluaciones[1], ...evaluaciones[2], ...evaluaciones[3]];
            
            // Convertir a formato de semanas para facilitar el procesamiento
            let semanas = [];
            for (let i = 0; i < TOTAL_WEEKS; i++) {
                semanas.push([poolMaterias[i * 2], poolMaterias[i * 2 + 1]]);
            }
            
            // Algoritmo mejorado para evitar repeticiones en la misma semana y sin consecutivas
            let cambiosRealizados = true;
            let maxIntentos = 100; // Límite de intentos para evitar bucles infinitos
            
            while (cambiosRealizados && maxIntentos > 0) {
                cambiosRealizados = false;
                maxIntentos--;
                
                for (let i = 0; i < semanas.length; i++) {
                    const semana = semanas[i];
                    
                    // 1. Evitar que la misma materia aparezca dos veces en la misma semana
                    if (semana[0] === semana[1]) {
                        cambiosRealizados = true;
                        
                        // Buscar una materia diferente en semanas cercanas para intercambiar
                        for (let j = 0; j < semanas.length; j++) {
                            if (i === j) continue;
                            
                            const otraSemana = semanas[j];
                            
                            // Intentar intercambiar con la primera posición de otra semana
                            if (otraSemana[0] !== semana[0] && otraSemana[0] !== otraSemana[1]) {
                                [semana[1], otraSemana[0]] = [otraSemana[0], semana[1]];
                                break;
                            }
                            
                            // Intentar intercambiar con la segunda posición de otra semana
                            if (otraSemana[1] !== semana[0] && otraSemana[0] !== otraSemana[1]) {
                                [semana[1], otraSemana[1]] = [otraSemana[1], semana[1]];
                                break;
                            }
                        }
                    }
                    
                    // 2. Evitar que una materia aparezca en semanas consecutivas
                    if (i > 0) {
                        const semanaAnterior = semanas[i - 1];
                        
                        // Verificar si alguna materia de esta semana está en la semana anterior
                        for (let s = 0; s < 2; s++) {
                            if (semanaAnterior.includes(semana[s])) {
                                cambiosRealizados = true;
                                
                                // Buscar una materia diferente en semanas posteriores para intercambiar
                                for (let j = i + 1; j < semanas.length; j++) {
                                    const semanaPosterior = semanas[j];
                                    
                                    // Verificar que el intercambio no cree nuevos problemas
                                    for (let sp = 0; sp < 2; sp++) {
                                        if (!semanaAnterior.includes(semanaPosterior[sp]) && 
                                            semanaPosterior[sp] !== semana[1-s]) {
                                            
                                            // Realizar el intercambio
                                            [semana[s], semanaPosterior[sp]] = [semanaPosterior[sp], semana[s]];
                                            break;
                                        }
                                    }
                                    
                                    if (!semanaAnterior.includes(semana[s])) break;
                                }
                            }
                        }
                    }
                }
            }
            
            // Convertir de nuevo a pool lineal
            return semanas.flat();
        }

        const poolMaterias = distribuirMateriasOptimizado();

        
        // --- CORRECCIÓN COMPLETA DEL BUCLE DE SCHEDULE ---
        const scheduleData = [];
        // Generar datos para las 36 semanas
        for (let i = 0; i < TOTAL_WEEKS; i++) {
            const materia2 = poolMaterias[i * 2] || 'Ámbito Socio-Lingüístico';
            const materia3 = poolMaterias[i * 2 + 1] || 'Cultura Científica';

            // --- Generación de Sesión 1 (Fija: CT) ---
            const crit1 = getRandomElement(criteriosCT);
            const act1 = generateCTActivity(crit1);
            
            const session1Data = {
                subject: 'Ámbito Científico-Tecnológico', 
                ambito: 'CT', 
                activity: act1,
                ce: crit1.text
            };
            
            // --- Generación de Sesión 2 (Variable) ---
            let session2Data = {};
            if (materia2 === 'Ámbito Científico-Tecnológico') {
                const crit = getRandomElement(criteriosCT);
                session2Data = {
                    subject: materia2,
                    ambito: 'CT',
                    activity: generateCTActivity(crit),
                    ce: crit.text
                };
            } else if (materia2 === 'Ámbito Socio-Lingüístico') {
                const crit = getRandomElement(criteriosSL);
                session2Data = {
                    subject: materia2,
                    ambito: 'SL',
                    activity: generateSLActivity(crit),
                    ce: crit.text
                };
            } else {
                // Para otras materias - CON ACTIVIDADES ESPECÍFICAS
                session2Data = {
                    subject: materia2,
                    ambito: ambitoMaterias[materia2] || 'XX',
                    activity: obtenerActividadEspecifica(materia2),
                    ce: seleccionarCriterio(materia2)
                };
            }
            
            // --- Generación de Sesión 3 (Variable) ---
            let session3Data = {};
            if (materia3 === 'Ámbito Científico-Tecnológico') {
                const crit = getRandomElement(criteriosCT);
                session3Data = {
                    subject: materia3,
                    ambito: 'CT',
                    activity: generateCTActivity(crit),
                    ce: crit.text
                };
            } else if (materia3 === 'Ámbito Socio-Lingüístico') {
                const crit = getRandomElement(criteriosSL);
                session3Data = {
                    subject: materia3,
                    ambito: 'SL',
                    activity: generateSLActivity(crit),
                    ce: crit.text
                };
            } else {
                // Para otras materias - CON ACTIVIDADES ESPECÍFICAS
                session3Data = {
                    subject: materia3,
                    ambito: ambitoMaterias[materia3] || 'XX',
                    activity: obtenerActividadEspecifica(materia3),
                    ce: seleccionarCriterio(materia3)
                };
            }

            const weekData = {
                week: i + 1,
                session1: session1Data,
                session2: session2Data,
                session3: session3Data
            };
            scheduleData.push(weekData);
        }

        const subjectColors = {
            'Ámbito Socio-Lingüístico': '#F97316', 'Religión': '#6B7280', 
            'Ámbito Científico-Tecnológico': '#4F46E5', 'Cultura Científica': '#10B981',
            'Expresión Artística': '#EF4444', 'Música': '#F59E0B', 
            'Educación Física': '#3B82F6', 'Dibujo Técnico': '#8B5CF6'
        };
        
        // Función para generar fechas - CORREGIDA
        function generateDates() {
            const dates = [];
            // Fecha de inicio: 15 de septiembre de 2025 (lunes)
            let currentDay = new Date('2025-09-15T00:00:00'); 
            
            // Fechas de inicio de los periodos tras vacaciones (lunes)
            const INICIO_SEGUNDA = new Date('2026-01-12T00:00:00'); 
            const INICIO_TERCERA = new Date('2026-04-06T00:00:00'); 

            for (let weekCount = 0; weekCount < TOTAL_WEEKS; weekCount++) {
                let start = new Date(currentDay);
                let end = new Date(currentDay);
                // El fin de la semana hábil es el viernes (4 días después del lunes)
                end.setDate(currentDay.getDate() + 4); 

                dates.push({ start, end });

                // Preparamos el inicio de la siguiente semana (saltando sábado y domingo)
                currentDay.setDate(currentDay.getDate() + 7);

                // Verificamos si acabamos de terminar la última semana de una evaluación
                if (weekCount === EVALUATION_WEEKS[1].end - 1) {
                    currentDay = INICIO_SEGUNDA;
                } else if (weekCount === EVALUATION_WEEKS[2].end - 1) {
                    currentDay = INICIO_TERCERA;
                }
            }
            return dates;
        }

        const weekDates = generateDates();

        function toggleEvaluation(evaluationNumber) {
            const content = document.getElementById(`evaluation-content-${evaluationNumber}`);
            const icon = document.getElementById(`toggle-icon-${evaluationNumber}`);
            content.classList.toggle('hidden');
            if (content.classList.contains('hidden')) {
                icon.textContent = '+';
            } else {
                icon.textContent = '-';
            }
        }
        window.toggleEvaluation = toggleEvaluation;

        document.addEventListener('DOMContentLoaded', () => {
            const subjectFiltersContainer = document.getElementById('subject-filters');
            const ambitoFiltersContainer = document.getElementById('ambito-filters');
            const resetBtn = document.getElementById('reset-filters');
            
            // Obtener todas las materias únicas
            const subjects = [...new Set([
                'Ámbito Científico-Tecnológico',
                'Ámbito Socio-Lingüístico',
                'Religión',
                'Cultura Científica',
                'Expresión Artística',
                'Música',
                'Educación Física',
                'Dibujo Técnico'
            ])].sort();
            
            // Obtener todos los ámbitos únicos
            const ambitos = [...new Set(Object.values(ambitoMaterias))].sort();

            function createFilterButtons(container, items, type) {
                items.forEach(item => {
                    const button = document.createElement('button');
                    button.textContent = item;
                    button.dataset.filter = item;
                    button.dataset.type = type;
                    button.className = 'filter-btn px-4 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200';
                    container.appendChild(button);
                });
            }

            function renderSchedule(data, containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                const evaluationNumber = parseInt(containerId.split('-').pop());
                const weekRange = EVALUATION_WEEKS[evaluationNumber];

                data.forEach(weekData => {
                    // Solo renderizar semanas dentro del rango de la evaluación
                    if (weekData.week >= weekRange.start && weekData.week <= weekRange.end) {
                        const weekCard = document.createElement('div');
                        weekCard.className = 'week-card bg-white rounded-2xl shadow-sm p-5';
                        weekCard.dataset.week = weekData.week;

                        const dateIndex = weekData.week - 1;
                        if (dateIndex < weekDates.length) {
                            const dateOptions = { day: 'numeric', month: 'long' }; 
                            const startDate = weekDates[dateIndex].start.toLocaleDateString('es-ES', dateOptions);
                            const endDate = weekDates[dateIndex].end.toLocaleDateString('es-ES', dateOptions);
                            
                            const dateRange = `del ${startDate} al ${endDate}`;

                            weekCard.innerHTML = `
                                <h3 class="text-xl font-bold text-indigo-700 mb-2">Semana ${weekData.week}</h3>
                                <p class="text-sm text-gray-500 mb-4">${dateRange}</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    ${createSessionCard(weekData.session1, 1, weekData.week)}
                                    ${createSessionCard(weekData.session2, 2, weekData.week)}
                                    ${createSessionCard(weekData.session3, 3, weekData.week)}
                                </div>
                            `;
                            container.appendChild(weekCard);
                        }
                    }
                });
            }

            function createSessionCard(session, sessionNumber, weekNumber) {
                // Obtener el enlace correspondiente del CSV
                const evidenceLink = evidenceLinks[weekNumber] ? 
                    evidenceLinks[weekNumber][`session${sessionNumber}`] : 
                    '#';
                
                return `
                    <div class="session-card rounded-xl p-4 border border-gray-200 transition-all duration-300 flex flex-col justify-between" 
                         data-subject="${session.subject}" data-ambito="${session.ambito}"
                         style="border-left: 5px solid ${subjectColors[session.subject] || '#6B7280'};">
                        
                        <div>
                            <p class="font-semibold text-sm text-gray-500">Sesión ${sessionNumber}</p>
                            <p class="font-bold text-gray-800">${session.subject}</p>
                            <p class="text-sm text-gray-600 mt-2">${session.activity}</p>
                            <p class="text-xs text-gray-400 mt-3 font-mono break-words">${session.ce}</p>
                        </div>
                        
                        <!-- Botón de Registro de Evidencia con enlace del CSV -->
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <a href="${evidenceLink}" target="_blank" class="w-full inline-flex justify-center items-center px-3 py-1.5 text-xs font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6m-4 5h10a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                Registrar evidencia
                            </a>
                        </div>
                    </div>
                `;
            }
            
            function applyFilter(filterValue, filterType) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white', 'hover:bg-indigo-700'));
                const activeButton = document.querySelector(`.filter-btn[data-filter="${filterValue}"][data-type="${filterType}"]`);
                if (activeButton) {
                    activeButton.classList.add('active', 'bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                }

                document.querySelectorAll('.week-card').forEach(weekCard => {
                    let weekHasMatch = false;
                    weekCard.querySelectorAll('.session-card').forEach(sessionCard => {
                        const isMatch = sessionCard.dataset[filterType] === filterValue;
                        if (isMatch) {
                            sessionCard.classList.remove('opacity-40');
                            sessionCard.classList.add('highlight');
                            weekHasMatch = true;
                        } else {
                            sessionCard.classList.add('opacity-40');
                            sessionCard.classList.remove('highlight');
                        }
                    });
                    
                    // Mostrar/ocultar semanas según si tienen match
                    if (weekHasMatch) {
                        weekCard.classList.remove('filtered-out', 'hidden-week');
                    } else {
                        weekCard.classList.add('hidden-week');
                    }
                });
            }

            function resetFilters() {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white', 'hover:bg-indigo-700'));
                document.querySelectorAll('.week-card').forEach(card => {
                    card.classList.remove('filtered-out', 'hidden-week');
                });
                document.querySelectorAll('.session-card').forEach(card => card.classList.remove('opacity-40', 'highlight'));
            }

            function renderChart() {
                const ctx = document.getElementById('proportionalityChart').getContext('2d');
                const sessionCounts = {};

                // Solo contamos las sesiones rotativas (2 y 3) para el gráfico
                scheduleData.forEach(week => {
                    [week.session2, week.session3].forEach(session => {
                        sessionCounts[session.subject] = (sessionCounts[session.subject] || 0) + 1;
                    });
                });
                
                const sortedSubjects = Object.keys(sessionCounts).sort((a, b) => sessionCounts[b] - sessionCounts[a]);
                const labels = sortedSubjects;
                const data = sortedSubjects.map(subject => sessionCounts[subject]);
                const backgroundColors = sortedSubjects.map(subject => subjectColors[subject] || '#6B7280');

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nº de Sesiones',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: '#FDFBF8',
                            borderWidth: 3,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 12
                                    },
                                    boxWidth: 15,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' sesiones';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createFilterButtons(subjectFiltersContainer, subjects, 'subject');
            createFilterButtons(ambitoFiltersContainer, ambitos, 'ambito');
            
            // Renderizar el calendario
            renderSchedule(scheduleData, 'evaluation-content-1');
            renderSchedule(scheduleData, 'evaluation-content-2');
            renderSchedule(scheduleData, 'evaluation-content-3');

            renderChart();
            
            document.getElementById('controls').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    const { filter, type } = e.target.dataset;
                    applyFilter(filter, type);
                }
            });

            resetBtn.addEventListener('click', resetFilters);
        });
    </script>
</body>
</html>