<!DOCTYPE html>
<html lang="es">
<head>
	<link rel="manifest" href="./manifest.json" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Favicon añadido -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>Plan de Razonamiento Matemático - 4º ESO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FDFBF8;
            color: #4A4A4A;
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        .filter-btn.active {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .week-card {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            transform: scale(1);
        }
        .week-card.filtered-out {
            opacity: 0.15;
            transform: scale(0.98);
        }
        .session-card.highlight {
            transform: scale(1.05);
            box-shadow: 0 0 0 2px #4F46E5;
        }
        .hidden-week {
            display: none !important;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">

        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Plan de Razonamiento Matemático (4º de ESO)</h1>
            <p class="mt-2 text-lg text-gray-600">Cronograma interactivo para 4º de ESO - Itinerario de Diversificación Curricular (<span id="total-weeks-display">36 semanas</span>)</p>
        </header>

        <main>
            <section id="controls" class="mb-12 p-6 bg-white rounded-2xl shadow-sm">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Filtrar por Asignatura</h3>
                    <div id="subject-filters" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Filtrar por Ámbito</h3>
                    <div id="ambito-filters" class="flex flex-wrap gap-2"></div>
                </div>
                 <div class="mt-6 text-center">
                    <button id="reset-filters" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition">Mostrar Todo</button>
                </div>
            </section>
            
            <section id="summary" class="mb-12">
                 <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-xl font-bold text-gray-800 text-center mb-4">Distribución Proporcional de Sesiones</h2>
                    <p class="text-center text-gray-600 mb-6 max-w-2xl mx-auto">
                        Este gráfico ilustra la distribución de las sesiones adicionales a lo largo del ciclo completo de 36 semanas. La asignación es directamente proporcional a la carga horaria semanal de cada materia, garantizando un reparto equitativo del trabajo interdisciplinar de razonamiento matemático.
                    </p>
                    <div class="chart-container relative w-full max-w-lg mx-auto h-80 md:h-96">
                        <canvas id="proportionalityChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="schedule">
                <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">Cronograma del Curso Escolar Completo</h2>
                <div id="evaluations-container" class="space-y-6">
                    <!-- Primera Evaluación: del 15 de septiembre de 2025 al 12 de diciembre (14 semanas) -->
                    <div class="evaluation-section bg-white rounded-2xl shadow-sm overflow-hidden">
                        <button class="w-full text-left p-6 flex justify-between items-center cursor-pointer focus:outline-none" onclick="toggleEvaluation(1)">
                            <h3 class="text-xl font-bold text-gray-800">Primera Evaluación (Semanas 1-14)</h3>
                            <span id="toggle-icon-1" class="text-2xl font-bold transform transition-transform duration-300">+</span>
                        </button>
                        <div id="evaluation-content-1" class="p-5 border-t border-gray-200 space-y-6 hidden">
                            <!-- Las semanas se renderizarán aquí -->
                        </div>
                    </div>
                    <!-- Segunda Evaluación: del 12 de enero de 2026 al 28 de marzo (11 semanas) -->
                    <div class="evaluation-section bg-white rounded-2xl shadow-sm overflow-hidden">
                        <button class="w-full text-left p-6 flex justify-between items-center cursor-pointer focus:outline-none" onclick="toggleEvaluation(2)">
                            <h3 class="text-xl font-bold text-gray-800">Segunda Evaluación (Semanas 15-25)</h3>
                            <span id="toggle-icon-2" class="text-2xl font-bold transform transition-transform duration-300">+</span>
                        </button>
                        <div id="evaluation-content-2" class="p-5 border-t border-gray-200 space-y-6 hidden">
                            <!-- Las semanas se renderizarán aquí -->
                        </div>
                    </div>
                    <!-- Tercera Evaluación: del 6 de abril al 19 de junio (11 semanas) -->
                    <div class="evaluation-section bg-white rounded-2xl shadow-sm overflow-hidden">
                        <button class="w-full text-left p-6 flex justify-between items-center cursor-pointer focus:outline-none" onclick="toggleEvaluation(3)">
                            <h3 class="text-xl font-bold text-gray-800">Tercera Evaluación (Semanas 26-36)</h3>
                            <span id="toggle-icon-3" class="text-2xl font-bold transform transition-transform duration-300">+</span>
                        </button>
                        <div id="evaluation-content-3" class="p-5 border-t border-gray-200 space-y-6 hidden">
                            <!-- Las semanas se renderizarán aquí -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- Configuraciones ajustadas a 36 semanas ---
        const TOTAL_WEEKS = 36;
        const EVALUATION_WEEKS = {
            1: { start: 1, end: 14 }, // 14 semanas: 15/sep al 12/dic
            2: { start: 15, end: 25 }, // 11 semanas: 12/ene al 28/mar
            3: { start: 26, end: TOTAL_WEEKS } // 11 semanas: 6/abr al 19/jun
        };

        // Datos del CSV con enlaces de evidencia
        const csvData = `,Sesión 1,Sesión 2,Sesión 3
Semana 1,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B5,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E5,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H5
Semana 2,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B10,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E10,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H10
Semana 3,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B17,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E17,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H17
Semana 4,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B22,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E22,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H22
Semana 5,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B27,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E27,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H27
Semana 6,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B32,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E32,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H32
Semana 7,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B37,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E37,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H37
Semana 8,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B44,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E44,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H44
Semana 9,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B49,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E49,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H49
Semana 10,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B54,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E54,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H54
Semana 11,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B59,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E59,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H59
Semana 12,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B66,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E66,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H66
Semana 13,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B71,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E71,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H71
Semana 14,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B76,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E76,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H76
Semana 15,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B83,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E83,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H83
Semana 16,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B88,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E88,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H88
Semana 17,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B93,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E93,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H93
Semana 18,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B100,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E100,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H100
Semana 19,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B105,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E105,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H105
Semana 20,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B110,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E110,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H110
Semana 21,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B115,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E115,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H115
Semana 22,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B122,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E122,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H122
Semana 23,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B127,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E127,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H127
Semana 24,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B132,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E132,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H132
Semana 25,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B137,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E137,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H137
Semana 26,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B144,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E144,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H144
Semana 27,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B149,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E149,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H149
Semana 28,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B154,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E154,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H154
Semana 29,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B159,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E159,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H159
Semana 30,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B166,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E166,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H166
Semana 31,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B171,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E171,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H171
Semana 32,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B176,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E176,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H176
Semana 33,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B181,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E181,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H181
Semana 34,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B188,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E188,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H188
Semana 35,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B193,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E193,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H193
Semana 36,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=B198,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=E198,https://docs.google.com/spreadsheets/d/1QEYC3Hy4nR0dzS8Uil6-c7JkNtDdsvclR-lf_vBhkqA/edit?gid=1960089933#gid=1960089933&range=H198`;

        // Parsear el CSV para crear un objeto con los enlaces por semana y sesión
        const evidenceLinks = {};
        const csvLines = csvData.split('\n');
        
        // Ignorar la primera línea (cabecera)
        for (let i = 1; i < csvLines.length; i++) {
            const line = csvLines[i].trim();
            if (!line) continue;
            
            const parts = line.split(',');
            if (parts.length >= 4) {
                const weekNumber = parseInt(parts[0].replace('Semana ', ''));
                evidenceLinks[weekNumber] = {
                    session1: parts[1],
                    session2: parts[2],
                    session3: parts[3]
                };
            }
        }

        // Distribución de horas semanales para el cálculo proporcional (no cambia)
        const horasSemanales = {
            'Ámbito Socio-Lingüístico': 9,
            'Religión': 1,
            'Ámbito Científico-Tecnológico': 8,
            'Cultura Científica': 2,
            'Expresión Artística': 3,
            'Música': 3,
            'Educación Física': 2,
            'Dibujo Técnico': 2
        };

        // Asignación de asignaturas a los ámbitos
        const ambitoMaterias = {
            'Ámbito Socio-Lingüístico': 'SL',
            'Religión': 'SL',
            'Ámbito Científico-Tecnológico': 'CT',
            'Cultura Científica': 'CT',
            'Expresión Artística': 'AR',
            'Música': 'AR',
            'Educación Física': 'AR',
            'Dibujo Técnico': 'AR'
        };

        // Criterios de evaluación de la Orden de 30 de mayo de 2023 (ejemplos adaptados para 4º ESO Diversificación)
        const criteriosEvaluacion = {
            'Ámbito Socio-Lingüístico': [
                'SL.C.E.1.2. Analizar y reconstruir la estructura lógica de textos orales y escritos, identificando su tesis, argumentos y conclusiones.',
                'SL.C.E.2.4. Utilizar estrategias de razonamiento deductivo e inductivo para la resolución de problemas en diferentes contextos.',
                'SL.C.E.3.1. Elaborar textos de opinión, utilizando argumentos sólidos y coherentes para defender una postura.',
                'SL.C.E.4.3. Interpretar la información de textos multimodales, como gráficos, mapas y diagramas, para la comprensión de datos.',
                'SL.C.E.5.1. Analizar el uso de falacias y sesgos cognitivos en los discursos, desarrollando un pensamiento crítico.',
            ],
            'Ámbito Científico-Tecnológico': [
                'CT.C.E.1.1. Emplear el pensamiento computacional para la resolución de problemas complejos, descomponiéndolos en partes más sencillas.',
                'CT.C.E.2.3. Interpretar y elaborar representaciones gráficas y simbólicas para describir fenómenos científicos y tecnológicos.',
                'CT.C.E.3.2. Aplicar el razonamiento lógico-matemático para la resolución de problemas numéricos en contextos científicos.',
                'CT.C.E.4.4. Analizar la validez y fiabilidad de los datos en investigaciones científicas, utilizando herramientas estadísticas básicas.',
                'CT.C.E.5.1. Diseñar y ejecutar pequeños proyectos de investigación, aplicando el método científico y la lógica experimental.',
            ],
            'Expresión Artística': [
                'AR.C.E.1.4. Analizar la proporción y la estructura geométrica en obras de arte, comprendiendo su impacto estético.',
                'AR.C.E.2.2. Desarrollar un proceso creativo, aplicando la lógica y la secuencia para la producción de obras artísticas.',
            ],
            'Música': [
                'AR.C.E.3.5. Interpretar patrones rítmicos y estructuras formales en obras musicales, relacionándolos con conceptos numéricos.',
                'AR.C.E.4.1. Utilizar técnicas de dibujo técnico para la representación de objetos tridimensionales, aplicando la geometría descriptiva.',
            ],
            'Educación Física': [
                'EF.C.E.1.3. Analizar la estrategia de juego en deportes de equipo, comprendiendo la lógica táctica.',
                'EF.C.E.2.2. Diseñar un plan de entrenamiento, aplicando el razonamiento para optimizar el rendimiento y la seguridad.',
                'EF.C.E.3.1. Interpretar la cinemática de los movimientos corporales, utilizando conceptos de física y geometría.',
            ],
            'Dibujo Técnico': [
                'DT.C.E.1.1. Representar objetos en el plano, utilizando el razonamiento espacial y las normas de la representación gráfica.',
                'DT.C.E.2.3. Resolver problemas geométricos complejos, aplicando los principios de la geometría plana y del espacio.',
                'DT.C.E.3.4. Emplear el razonamiento lógico para la lectura e interpretación de planos y croquis.',
            ],
            'Cultura Científica': [
                'CC.C.E.1.2. Interpretar datos científicos presentados en gráficos y tablas, extrayendo conclusiones lógicas.',
                'CC.C.E.2.3. Analizar la argumentación en debates científicos, identificando la validez de las hipótesis y las pruebas.',
                'CC.C.E.3.1. Utilizar el pensamiento crítico para la evaluación de la información científica de diversas fuentes.'
            ],
            'Religión': [
                'RE.C.E.1.2. Analizar dilemas éticos y morales, aplicando un razonamiento coherente para la toma de decisiones.',
                'RE.C.E.2.1. Interpretar textos sagrados, identificando la estructura lógica y el mensaje principal.',
            ]
        };

        function seleccionarCriterio(materia) {
            const criterios = criteriosEvaluacion[materia];
            return criterios ? criterios[Math.floor(Math.random() * criterios.length)] : 'Criterio de evaluación no especificado';
        }

        const totalHoras = Object.values(horasSemanales).reduce((sum, h) => sum + h, 0);
        // Ajustado a 36 semanas * 2 sesiones/semana = 72 sesiones
        const totalSesionesAdicionales = TOTAL_WEEKS * 2; 
        
        const sesionesProporcionales = Object.keys(horasSemanales).reduce((acc, materia) => {
            // Utilizamos el total de sesiones adicionales
            acc[materia] = Math.round((horasSemanales[materia] / totalHoras) * totalSesionesAdicionales);
            return acc;
        }, {});
        
        // Ajuste fino para asegurar que la suma es exactamente totalSesionesAdicionales (72)
        const currentSum = Object.values(sesionesProporcionales).reduce((sum, n) => sum + n, 0);
        const diff = totalSesionesAdicionales - currentSum;
        if (diff !== 0) {
            // Añade/resta la diferencia a la materia con más peso para mantener la proporción
            const primarySubject = 'Ámbito Socio-Lingüístico'; // Mayor peso
            sesionesProporcionales[primarySubject] = (sesionesProporcionales[primarySubject] || 0) + diff;
        }

        // --- ALGORITMO MEJORADO: Distribución uniforme por evaluación ---
        function distribuirMateriasUniformemente() {
            // Calcular sesiones por evaluación
            const sesionesPorEvaluacion = {
                1: 14 * 2, // 28 sesiones
                2: 11 * 2, // 22 sesiones  
                3: 11 * 2  // 22 sesiones
            };
            
            // Crear arrays separados para cada evaluación
            const evaluaciones = {
                1: [],
                2: [], 
                3: []
            };
            
            // Para cada materia, distribuir sus sesiones entre las evaluaciones
            Object.keys(sesionesProporcionales).forEach(materia => {
                const totalSesionesMateria = sesionesProporcionales[materia];
                
                // Calcular distribución ideal entre evaluaciones
                const distribucionIdeal = {
                    1: Math.round(totalSesionesMateria * (sesionesPorEvaluacion[1] / totalSesionesAdicionales)),
                    2: Math.round(totalSesionesMateria * (sesionesPorEvaluacion[2] / totalSesionesAdicionales)),
                    3: totalSesionesMateria // Se ajustará después
                };
                
                // Ajustar para que sume el total
                distribucionIdeal[3] = totalSesionesMateria - distribucionIdeal[1] - distribucionIdeal[2];
                
                // Asegurar que no haya valores negativos
                if (distribucionIdeal[3] < 0) {
                    distribucionIdeal[3] = 0;
                    // Reajustar las otras dos
                    const sobrante = Math.abs(distribucionIdeal[3]);
                    if (distribucionIdeal[1] > sobrante) {
                        distribucionIdeal[1] -= sobrante;
                    } else if (distribucionIdeal[2] > sobrante) {
                        distribucionIdeal[2] -= sobrante;
                    }
                }
                
                // Añadir las sesiones a cada evaluación
                for (let i = 0; i < distribucionIdeal[1]; i++) evaluaciones[1].push(materia);
                for (let i = 0; i < distribucionIdeal[2]; i++) evaluaciones[2].push(materia);
                for (let i = 0; i < distribucionIdeal[3]; i++) evaluaciones[3].push(materia);
            });
            
            // Mezclar cada evaluación por separado (pero de forma determinista)
            const mezclarDeterminista = (array) => {
                const nuevoArray = [...array];
                for (let i = nuevoArray.length - 1; i > 0; i--) {
                    const j = Math.floor((i * 13 + 7) % (i + 1));
                    [nuevoArray[i], nuevoArray[j]] = [nuevoArray[j], nuevoArray[i]];
                }
                return nuevoArray;
            };
            
            // Mezclar cada evaluación
            evaluaciones[1] = mezclarDeterminista(evaluaciones[1]);
            evaluaciones[2] = mezclarDeterminista(evaluaciones[2]);
            evaluaciones[3] = mezclarDeterminista(evaluaciones[3]);
            
            // Combinar todas las evaluaciones en un solo pool
            const poolMaterias = [...evaluaciones[1], ...evaluaciones[2], ...evaluaciones[3]];
            
            return poolMaterias;
        }

        const poolMaterias = distribuirMateriasUniformemente();

        const ambitosMap = {
            'Ámbito Socio-Lingüístico': 'SL',
            'Religión': 'SL',
            'Ámbito Científico-Tecnológico': 'CT',
            'Cultura Científica': 'CT',
            'Expresión Artística': 'AR',
            'Música': 'AR',
            'Educación Física': 'AR',
            'Dibujo Técnico': 'AR'
        };
        
        const scheduleData = [];
        // Generar datos solo para las 36 semanas
        for (let i = 0; i < TOTAL_WEEKS; i++) {
            // Se utiliza el operador ternario para evitar acceder a índices fuera de los límites
            const materia2 = poolMaterias[i * 2] || 'Error de Materia';
            const materia3 = poolMaterias[i * 2 + 1] || 'Error de Materia';

            const weekData = {
                week: i + 1,
                session1: { 
                    subject: 'Ámbito Científico-Tecnológico', 
                    ambito: 'CT', 
                    activity: 'Taller de resolución de un problema de proporcionalidad o lógica elemental.',
                    ce: seleccionarCriterio('Ámbito Científico-Tecnológico')
                },
                session2: {
                    subject: materia2,
                    // Asegurar ámbito para evitar errores
                    ambito: ambitosMap[materia2] || 'XX',
                    activity: `Actividad de razonamiento matemático en el contexto de la asignatura de ${materia2}.`,
                    ce: seleccionarCriterio(materia2)
                },
                session3: {
                    subject: materia3,
                    // Asegurar ámbito para evitar errores
                    ambito: ambitosMap[materia3] || 'XX',
                    activity: `Actividad de razonamiento matemático en el contexto de la asignatura de ${materia3}.`,
                    ce: seleccionarCriterio(materia3)
                }
            };
            scheduleData.push(weekData);
        }

        const subjectColors = {
            'Ámbito Socio-Lingüístico': '#F97316', 'Religión': '#6B7280', 
            'Ámbito Científico-Tecnológico': '#4F46E5', 'Cultura Científica': '#10B981',
            'Expresión Artística': '#EF4444', 'Música': '#F59E0B', 
            'Educación Física': '#3B82F6', 'Dibujo Técnico': '#8B5CF6',
            'Error de Materia': '#333333' // Color de respaldo
        };
        
        // --- FUNCIÓN CORREGIDA PARA GARANTIZAR 36 SEMANAS SIN SALTARSE NINGUNA ---
        // Y MODIFICADA PARA REFLEJAR SOLO DÍAS HÁBILES (LUNES A VIERNES)
        function generateDates() {
            const dates = [];
            // Fecha de inicio: 15 de septiembre de 2025 (lunes)
            let currentDay = new Date('2025-09-15T00:00:00'); 
            
            // Fechas de inicio de los periodos tras vacaciones (lunes)
            const INICIO_SEGUNDA = new Date('2026-01-12T00:00:00'); 
            const INICIO_TERCERA = new Date('2026-04-06T00:00:00'); 

            for (let weekCount = 0; weekCount < TOTAL_WEEKS; weekCount++) {
                let start = new Date(currentDay);
                let end = new Date(currentDay);
                // El fin de la semana hábil es el viernes (4 días después del lunes)
                end.setDate(currentDay.getDate() + 4); 

                dates.push({ start, end }); // Agregamos la semana actual

                // Preparamos el inicio de la siguiente semana (saltando sábado y domingo)
                currentDay.setDate(currentDay.getDate() + 7);

                // Verificamos si acabamos de terminar la última semana de una evaluación
                if (weekCount === EVALUATION_WEEKS[1].end - 1) { // Final de la semana 14 (índice 13)
                    // Saltamos al inicio de la segunda evaluación
                    currentDay = INICIO_SEGUNDA;
                } else if (weekCount === EVALUATION_WEEKS[2].end - 1) { // Final de la semana 25 (índice 24)
                    // Saltamos al inicio de la tercera evaluación
                    currentDay = INICIO_TERCERA;
                }
            }
            return dates;
        }

        const weekDates = generateDates();

        function toggleEvaluation(evaluationNumber) {
            const content = document.getElementById(`evaluation-content-${evaluationNumber}`);
            const icon = document.getElementById(`toggle-icon-${evaluationNumber}`);
            content.classList.toggle('hidden');
            if (content.classList.contains('hidden')) {
                icon.textContent = '+';
            } else {
                icon.textContent = '-';
            }
        }
        window.toggleEvaluation = toggleEvaluation;

        document.addEventListener('DOMContentLoaded', () => {
            const subjectFiltersContainer = document.getElementById('subject-filters');
            const ambitoFiltersContainer = document.getElementById('ambito-filters');
            const resetBtn = document.getElementById('reset-filters');
            
            // Usamos una pequeña validación por si alguna materia no se asignó correctamente
            const validPoolMaterias = poolMaterias.filter(m => m !== 'Error de Materia');
            const subjects = [...new Set(validPoolMaterias)].sort();
            
            // Re-añadir 'Ámbito Científico-Tecnológico' ya que está en la sesión 1 fija y podría no estar en el pool
            if (!subjects.includes('Ámbito Científico-Tecnológico')) {
                subjects.unshift('Ámbito Científico-Tecnológico');
            }
            
            const ambitos = [...new Set(Object.values(ambitosMap))].sort();

            function createFilterButtons(container, items, type) {
                items.forEach(item => {
                    const button = document.createElement('button');
                    button.textContent = item;
                    button.dataset.filter = item;
                    button.dataset.type = type;
                    button.className = 'filter-btn px-4 py-1.5 text-sm font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200';
                    container.appendChild(button);
                });
            }

            function renderSchedule(data, containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                const evaluationNumber = parseInt(containerId.split('-').pop());
                const weekRange = EVALUATION_WEEKS[evaluationNumber];

                data.forEach(weekData => {
                    // Solo renderizar semanas dentro del rango de la evaluación
                    if (weekData.week >= weekRange.start && weekData.week <= weekRange.end) {
                        const weekCard = document.createElement('div');
                        weekCard.className = 'week-card bg-white rounded-2xl shadow-sm p-5';
                        weekCard.dataset.week = weekData.week;

                        // Aseguramos que el índice existe en weekDates (de 0 a 35)
                        const dateIndex = weekData.week - 1;
                        if (dateIndex < weekDates.length) {
                            // --- Rango de fechas sin año ni días de la semana ---
                            const dateOptions = { day: 'numeric', month: 'long' }; 
                            const startDate = weekDates[dateIndex].start.toLocaleDateString('es-ES', dateOptions);
                            const endDate = weekDates[dateIndex].end.toLocaleDateString('es-ES', dateOptions);
                            
                            const dateRange = `del ${startDate} al ${endDate}`;

                            weekCard.innerHTML = `
                                <h3 class="text-xl font-bold text-indigo-700 mb-2">Semana ${weekData.week}</h3>
                                <p class="text-sm text-gray-500 mb-4">${dateRange}</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    ${createSessionCard(weekData.session1, 1, weekData.week)}
                                    ${createSessionCard(weekData.session2, 2, weekData.week)}
                                    ${createSessionCard(weekData.session3, 3, weekData.week)}
                                </div>
                            `;
                            container.appendChild(weekCard);
                        }
                    }
                });
            }

            function createSessionCard(session, sessionNumber, weekNumber) {
                // Obtener el enlace correspondiente del CSV
                const evidenceLink = evidenceLinks[weekNumber] ? 
                    evidenceLinks[weekNumber][`session${sessionNumber}`] : 
                    '#';
                
                // Generamos un ID único para la sesión (útil para asociar la evidencia)
                const sessionId = `week-${weekNumber}-session-${sessionNumber}`; 
                
                return `
                    <div class="session-card rounded-xl p-4 border border-gray-200 transition-all duration-300 flex flex-col justify-between" 
                         data-subject="${session.subject}" data-ambito="${session.ambito}" data-session-id="${sessionId}"
                         style="border-left: 5px solid ${subjectColors[session.subject] || '#6B7280'};">
                        
                        <div>
                            <p class="font-semibold text-sm text-gray-500">Sesión ${sessionNumber}</p>
                            <p class="font-bold text-gray-800">${session.subject}</p>
                            <p class="text-sm text-gray-600 mt-2">${session.activity}</p>
                            <p class="text-xs text-gray-400 mt-3 font-mono break-words">${session.ce}</p>
                        </div>
                        
                        <!-- Botón de Registro de Evidencia con enlace del CSV -->
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <a href="${evidenceLink}" target="_blank" class="w-full inline-flex justify-center items-center px-3 py-1.5 text-xs font-semibold rounded-lg text-white bg-green-600 hover:bg-green-700 transition shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6m-4 5h10a2 2 0 002-2V7a2 2 0 00-2-2H9a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                Registrar evidencia
                            </a>
                        </div>
                    </div>
                `;
            }
            
            function applyFilter(filterValue, filterType) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white', 'hover:bg-indigo-700'));
                const activeButton = document.querySelector(`.filter-btn[data-filter="${filterValue}"][data-type="${filterType}"]`);
                if (activeButton) {
                    activeButton.classList.add('active', 'bg-indigo-600', 'text-white', 'hover:bg-indigo-700');
                }

                document.querySelectorAll('.week-card').forEach(weekCard => {
                    let weekHasMatch = false;
                    weekCard.querySelectorAll('.session-card').forEach(sessionCard => {
                        const isMatch = sessionCard.dataset[filterType] === filterValue;
                        if (isMatch) {
                            sessionCard.classList.remove('opacity-40');
                            sessionCard.classList.add('highlight');
                            weekHasMatch = true;
                        } else {
                            sessionCard.classList.add('opacity-40');
                            sessionCard.classList.remove('highlight');
                        }
                    });
                    
                    // Ocultar completamente las semanas que no tengan la materia
                    if (weekHasMatch) {
                        weekCard.classList.remove('filtered-out', 'hidden-week');
                    } else {
                        weekCard.classList.add('hidden-week');
                    }
                });
            }

            function resetFilters() {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white', 'hover:bg-indigo-700'));
                document.querySelectorAll('.week-card').forEach(card => {
                    card.classList.remove('filtered-out', 'hidden-week');
                });
                document.querySelectorAll('.session-card').forEach(card => card.classList.remove('opacity-40', 'highlight'));
            }

            function renderChart() {
                const ctx = document.getElementById('proportionalityChart').getContext('2d');
                const sessionCounts = {};

                // Solo contamos las sesiones rotativas (2 y 3) para el gráfico
                scheduleData.forEach(week => {
                    [week.session2, week.session3].forEach(session => {
                        sessionCounts[session.subject] = (sessionCounts[session.subject] || 0) + 1;
                    });
                });
                
                const sortedSubjects = Object.keys(sessionCounts).sort((a, b) => sessionCounts[b] - sessionCounts[a]);
                const labels = sortedSubjects;
                const data = sortedSubjects.map(subject => sessionCounts[subject]);
                const backgroundColors = sortedSubjects.map(subject => subjectColors[subject] || '#6B7280');

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Nº de Sesiones',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: '#FDFBF8',
                            borderWidth: 3,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        size: 12
                                    },
                                    boxWidth: 15,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed + ' sesiones';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createFilterButtons(subjectFiltersContainer, subjects, 'subject');
            createFilterButtons(ambitoFiltersContainer, ambitos, 'ambito');
            
            // Renderizar el calendario. Al pasar toda la data, el renderSchedule se encarga de filtrar por rango de semanas.
            renderSchedule(scheduleData, 'evaluation-content-1');
            renderSchedule(scheduleData, 'evaluation-content-2');
            renderSchedule(scheduleData, 'evaluation-content-3');

            renderChart();
            
            document.getElementById('controls').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    const { filter, type } = e.target.dataset;
                    applyFilter(filter, type);
                }
            });

            resetBtn.addEventListener('click', resetFilters);
        });
    </script>
</body>
</html>